<html>
<head>
  <title>Location PWA Test</title>
  <meta name="viewport" content="width=device-width">
  <meta name="apple-mobile-web-app-title" content="Location PWA">
  
  <script type="text/javascript">
    function getLocation () {
      const promiseArray = []

      if (navigator.standalone) {
        promiseArray.push(new Promise((resolve, reject) => {
          const wait = setTimeout(() => {
            clearTimeout(wait)
            reject(new Error('Location has timed out'))
          }, 4000)
        }))
      }

      const getCurrentPositionPromise = new Promise((resolve, reject) => {
        if ('geolocation' in navigator) {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            timeout: 5000,
            maximumAge: 2000,
            enableHighAccuracy: false
          })
        } else {
          reject(new Error('Browser does not support geolocation!'))
        }
      })

      promiseArray.push(getCurrentPositionPromise)
      return Promise.race(promiseArray)
    }
      
    function test(){
      getLocation().then(function(l){
        document.querySelector('p').innerText = JSON.stringify(l)
      }).catch(function(e){
        document.querySelector('p').innerText = 'Error:\n\n' + JSON.stringify(e)
      })
    }
  </script>
</head>
<body>
  <pre></pre>
  <button onclick="test()">test</button>
</body>
</html>
